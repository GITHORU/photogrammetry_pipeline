name: Build Executables

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

jobs:
  # ============================================================================
  # ðŸ³ DOCKER BUILDS - Queue rapide + Environnements prÃ©cis
  # ============================================================================
  
  build-docker:
    strategy:
      matrix:
        include:
          # Rocky Linux 8 - CompatibilitÃ© RHEL 8.2 / GLIBC 2.28 
          - container: rockylinux:8
            python-version: '3.6'
            spec-file: photogeoalign_rocky8.spec
            artifact-name: photogeoalign-rocky8-docker
            platform: linux
            glibc-version: "2.28"
            
          # Ubuntu 22.04 - Moderne + performant  
          - container: ubuntu:22.04
            python-version: '3.11'
            spec-file: photogeoalign_linux.spec
            artifact-name: photogeoalign-ubuntu22-docker
            platform: linux
            glibc-version: "2.35"

    runs-on: ubuntu-latest  # âš¡ Queue rapide garantie !
    container: ${{ matrix.container }}
    
    steps:
    - name: Setup container environment
      run: |
        # ðŸ”§ Configuration universelle
        export TZ=Europe/Paris
        
        # ðŸ“¦ Installation conditionnelle selon l'OS
        if [[ "${{ matrix.container }}" == centos* ]] || [[ "${{ matrix.container }}" == rockylinux* ]]; then
          # CentOS/RHEL/Rocky setup
          yum update -y
          yum install -y python3 python3-pip python3-devel git gcc gcc-c++ make \
                         mesa-libGL libgomp zlib-devel
          ln -sf /usr/bin/python3 /usr/bin/python
        else
          # Ubuntu/Debian setup  
          export DEBIAN_FRONTEND=noninteractive
          ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
          apt-get update
          apt-get install -y python3 python3-pip python3-dev git build-essential \
                             libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 \
                             libxrender-dev libgomp1
          ln -sf /usr/bin/python3 /usr/bin/python
        fi
        
        # ðŸ“Š Info version
        echo "=== Container Info ==="
        cat /etc/os-release
        python3 --version
        ldd --version | head -1
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Fix Git ownership
      run: |
        git config --global --add safe.directory $GITHUB_WORKSPACE
    
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        
        # Installation conditionnelle selon Python version
        if [[ "${{ matrix.container }}" == rockylinux* ]]; then
          # Rocky 8: Python 3.6 â†’ PyInstaller 4.10 + requirements sans pyinstaller
          pip3 install PySide6 open3d numpy pyproj scipy Pillow rasterio pytest pytest-qt
          pip3 install "pyinstaller>=4.10,<5.0.0"
        else
          # Ubuntu: Python 3.11 â†’ requirements.txt complet
          pip3 install -r requirements.txt
        fi
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: docker-${{ matrix.container }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          docker-${{ matrix.container }}-pip-
    
    - name: Create hooks directory
      run: |
        python3 -c "import os; os.makedirs('hooks', exist_ok=True); print('Hooks directory ready')"
    
    - name: Verify spec file exists
      run: |
        python3 -c "import os; print(f'Spec file: ${{ matrix.spec-file }}'); print('Exists:', os.path.exists('${{ matrix.spec-file }}'))"
    
    - name: Build executable
      run: |
        pyinstaller ${{ matrix.spec-file }} --clean --noconfirm
    
    - name: Verify executable exists
      run: |
        python3 -c "import os; print('Dist contents:'); [print(f'  {f}') for f in os.listdir('dist') if os.path.exists('dist')]"
    
    - name: Test executable (basic smoke test)
      run: |
        python3 -c "import os, sys; os.chdir('dist'); files=os.listdir('.'); exe_files=[f for f in files if f.startswith('photogeoalign') and '.' not in f.split('/')[-1]]; print(f'Found executables: {exe_files}'); sys.exit(0 if exe_files else 1)"
    
    - name: GLIBC compatibility check
      run: |
        echo "=== GLIBC Analysis ==="
        echo "Expected GLIBC: ${{ matrix.glibc-version }}"
        if [ -f dist/photogeoalign ]; then
          echo "Executable dependencies:"
          ldd dist/photogeoalign | grep -E "(libc|GLIBC)" || echo "No GLIBC deps found"
          echo "Executable info:"
          file dist/photogeoalign
        fi
    
    - name: Prepare artifact
      run: |
        python3 -c "import os, shutil; os.makedirs('release', exist_ok=True); files=[f for f in os.listdir('dist') if f.startswith('photogeoalign')]; [shutil.copy(f'dist/{f}', 'release/') for f in files]; print(f'Copied: {files}')"
        python3 -c "import shutil; shutil.copy('README.md', 'release/'); shutil.copy('requirements.txt', 'release/'); print('Added README and requirements')"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: release/
        retention-days: 30
    
    - name: Create release archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd release
        tar -czf ../photogeoalign-${{ github.ref_name }}-${{ matrix.artifact-name }}.tar.gz *
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          photogeoalign-${{ github.ref_name }}-*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # ðŸªŸ WINDOWS BUILD - Natif (pas de container Windows disponible)
  # ============================================================================
  
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: windows-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          windows-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create hooks directory
      run: |
        python -c "import os; os.makedirs('hooks', exist_ok=True); print('Hooks directory ready')"
    
    - name: Build executable
      run: |
        pyinstaller photogeoalign_windows.spec --clean --noconfirm
    
    - name: Verify executable exists
      run: |
        python -c "import os; print('Dist contents:'); [print(f'  {f}') for f in os.listdir('dist') if os.path.exists('dist')]"
    
    - name: Test executable (basic smoke test)
      run: |
        python -c "import os, sys; os.chdir('dist'); files=os.listdir('.'); exe_files=[f for f in files if f.endswith('.exe')]; print(f'Found executables: {exe_files}'); sys.exit(0 if exe_files else 1)"
    
    - name: Prepare artifact
      run: |
        python -c "import os, shutil; os.makedirs('release', exist_ok=True); files=[f for f in os.listdir('dist') if f.startswith('photogeoalign')]; [shutil.copy(f'dist/{f}', 'release/') for f in files]; print(f'Copied: {files}')"
        python -c "import shutil; shutil.copy('README.md', 'release/'); shutil.copy('requirements.txt', 'release/'); print('Added README and requirements')"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: photogeoalign-windows-docker
        path: release/
        retention-days: 30
    
    - name: Create release archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd release
        7z a ../photogeoalign-${{ github.ref_name }}-windows.zip *
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          photogeoalign-${{ github.ref_name }}-windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # ðŸ“Š NOTIFICATION - Status de tous les builds
  # ============================================================================
  
  notify:
    needs: [build-docker, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Build Status Summary
      run: |
        echo "ðŸ—ï¸ Build Summary - Docker Strategy"
        echo "=================================="
        echo "ðŸ³ Docker builds: ${{ needs.build-docker.result }}"
        echo "ðŸªŸ Windows build: ${{ needs.build-windows.result }}"
        echo ""
        echo "ðŸ“¦ Expected artifacts:"
        echo "  â€¢ photogeoalign-rocky8-docker (GLIBC 2.28 - RHEL 8.2 + Python 3.6)"
        echo "  â€¢ photogeoalign-ubuntu22-docker (GLIBC 2.35 - Moderne)" 
        echo "  â€¢ photogeoalign-windows-docker (.exe)"
        echo ""
        echo "âš¡ Docker benefits: Queue rapide + environnements prÃ©cis!"
